files:
  "/etc/nginx/conf.d/02_https_redirect.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Force HTTPS redirect (only for production with load balancer)
      # This checks if the request came through the load balancer via HTTP
      server {
          listen 80;
          
          # Check if the request is HTTP (from load balancer)
          if ($http_x_forwarded_proto = 'http') {
              return 301 https://$host$request_uri;
          }
      }

  "/etc/nginx/conf.d/03_security_headers.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Additional security headers
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      
      # Enable HSTS (only for HTTPS)
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

  "/etc/nginx/conf.d/04_compression.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Gzip compression for better performance
      gzip on;
      gzip_vary on;
      gzip_proxied any;
      gzip_comp_level 6;
      gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
      gzip_disable "msie6";

  "/opt/elasticbeanstalk/tasks/taillogs.d/nodejs-app.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      /var/log/nodejs/nodejs.log

container_commands:
  01_reload_nginx:
    command: "sudo service nginx reload"
    ignoreErrors: true
